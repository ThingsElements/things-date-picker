<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-date-picker/paper-date-picker.html">
<link rel="import" href="../paper-date-picker/paper-date-picker-dialog-style.html">
<link rel="import" href="../things-button/things-button.html">
<link rel="import" href="../things-msg-box-behavior/things-msg-box-behavior.html">
<link rel="import" href="../things-input-field/things-input-field.html">

<!--
`<things-date-from-to>` From Date와 To Date를 입력받아 기간을 표현하는 컴퍼넌트

  Example
    
    <things-date-from-to 
      locale="ko" 
      read-format="YYYY-MM-DD">
    </things-date-from-to>

@demo demo/demo-things-date-from-to.html
-->
<dom-module id="things-date-from-to">

  <template>
    <style>
      .input-fieldset{
        @apply(--layout-flex)
      }
      things-input-field::shadow label{

      }
      things-input-field::shadow input{
          width:calc(65% - 37px)
      }
      paper-icon-button.clear{
        @apply(--things-small-icon);
        margin-left:-26px;
        margin-right:6px;
        opacity:.4;
        position:relative;
        top:-2px;
      }
      paper-icon-button.picker{
        @apply(--things-picker-button);
        background:url(/images/icon-resource-select.png) 55% -97px no-repeat var(--paper-blue-grey-300);
        top:1px;
      }
    </style>

    <things-input-field hidden name="[[name]]" value="[[value]]"></things-input-field>
    <div class="layout horizontal">
      <div class="input-fieldset">
          <things-input-field
            label="[[fromLabel]]"
            type="text"
            name="fromDate"
            is-valid="[[fromValid]]"
            error-message="[[errorMessage]]"
            value="{{selectedFromDate}}"
            class="flex"
            readonly>
          </things-input-field>
          <paper-icon-button class="clear" icon="clear" on-tap="clearFrom"></paper-icon-button>
          <paper-icon-button class="picker" on-tap="openFromPicker"></paper-icon-button>
      </div>

      <div class="input-fieldset">
          <things-input-field
            label="[[toLabel]]"
            type="text"
            name="toDate"
            is-valid="[[toValid]]"
            error-message="[[errorMessage]]"
            value="{{selectedToDate}}"
            readonly>
          </things-input-field>
          <paper-icon-button class="clear" icon="clear" on-tap="clearTo"></paper-icon-button>
          <paper-icon-button class="picker" on-tap="openToPicker"></paper-icon-button>
      </div>
    </div>

  </template>

  <script>
    Polymer({
      is: 'things-date-from-to',

      behaviors: [ 
        Things.MsgBoxBehavior
      ],

      properties: {
        /**
         * Name
         */        
        name: {
          type: String
        },

        /**
         * label name
         */
        label: {
          type: String,
          observer: '_labelChanged'
        },

        /**
         * from field label name
         */
        fromLabel: {
          type: String,
          value: 'From'
        },

        /**
         * to field label name
         */
        toLabel: {
          type: String,
          value: 'To'
        },

        /**
         * Date picker의 기준이 되는 locale을 설정한다.
         */
        locale: {
          type: String,
          notify: true,
          value: 'en'
        },

        /**
         * date의 읽기전용 format을 설정한다.
         */
        readFormat: {
          type: String,
          notify: true,
          value: 'YYYY-MM-DD'
        },

        /**
         * date의 쓰기전용 format을 설정한다.
         */
        writeFormat: {
          type: String,
          value: 'YYYY-MM-DD'
        },

        /**
         * Form Submit시에 넘어갈 값 ex) 2015-05-01,2016-05-31
         */
        value: {
          type: String
        },

        /**
         * from - to picker 사이의 선택 가능 일수 (허용 범위)
         */
        allowRange: {
          type: Number
        },

        /**
         * input field의 입력된 값이 allowRange에 부함하지 않을 경우 나타나는 메시지
         */
        errorMessage: {
          type: String
        }
      },

      observers: [
        '_selectedFromDateChanged(selectedFromDate)',
        '_selectedToDateChanged(selectedToDate)'
      ],      

      /**
       * label을 property로 받아서 fromLabel과 toLabel을 초기화 합니다.
       */
      _labelChanged: function(label) {
        this.fromLabel = label + ' (From)';
        this.toLabel = label + ' (to)';
      },

      /**
       * 버튼 클릭시 Date picker를 dialog 타입으로 나타나게 한다.
       */
      openFromPicker: function() {
        var dataObj = {
          owner: this,
          date: (this.selectedFromDate) ? new Date(this.selectedFromDate) : new Date()
        };  

        app.$['date-picker-dialog'].dialogToggle(dataObj, this._applyFromDate);
      },

      /**
       * 버튼 클릭시 Date picker를 dialog 타입으로 나타나게 한다.
       */      
      openToPicker: function() {
        var dataObj = {
          owner: this,
          date: (this.selectedToDate) ? new Date(this.selectedToDate) : new Date()
        };  

        app.$['date-picker-dialog'].dialogToggle(dataObj, this._applyToDate);        
      },

      /**
       * things-date-picker-dialog에 전달할 callback 함수
       * selectedFromDate를 초기화 하고 dialogValidation 함수를 통해 from date와 to date 간의 validation check, false return시 selectedFromDate를 clear
       */
      _applyFromDate: function(dataObj) {
        this.selectedFromDate = dataObj.date;

        var isValid = this.dialogValidation();
        if(!isValid)
          this.selectedFromDate = '';
      },

      /**
       * things-date-picker-dialog에 전달할 callback 함수
       * selectedToDate를 초기화 하고 dialogValidation 함수를 통해 from date와 to date 간의 validation check, false return시 selectedToDate를 clear
       */
      _applyToDate: function(dataObj) {
        this.selectedToDate = dataObj.date;

        var isValid = this.dialogValidation();
        if(!isValid)
          this.selectedToDate = '';
      },

      /**
       * from date와 to date 간의 범위 validation check, valid = true return, invalid = false return
       */
      dialogValidation: function() {
        if(this.selectedFromDate && this.selectedToDate && this.selectedFromDate > this.selectedToDate)  {
          this.openInfoMsg({ title : 'Invalid Date Range!', text : 'Please Select Proper Date.', type : 'info', timer : 5000 });
          return false;
        }
        return true;
      },

      /**
       * 선택된 from date를 빈값으로 초기화하며 inputfield의 vaild를 true로 설정
       */
      clearFrom: function() {
        this.selectedFromDate = '';
      },

      /**
       * 선택된 to date를 빈값으로 초기화며 inputfield의 vaild를 true로 설정
       */
      clearTo: function() {
        this.selectedToDate = '';
      },

      /**
       * From Date 선택시 - value 변경
       * 입력받은 date를 formatting 함수를 통해 formatting하고 string으로 초기화 합니다.
       * allowRange가 있다면 toValidateion함수를 호출 합니다.
       */
      _selectedFromDateChanged: function(date) {
        this.selectedFromDate = this.formatting(date);
        if(!this.value) {
          this.value = this.selectedFromDate + ',';
        } else {
          valueArr = this.value.split(',');
          valueArr[0] = this.selectedFromDate;
          this.value = valueArr.join(',');
        }

        if(this.value == ",") {
          this.value = "";
        }

        if(this.allowRange && this.allowRange != '') {
          this.fromValidation();
        }
      },

      /**
       * To Date 선택시 - value 변경
       * 입력받은 date를 formatting 함수를 통해 formatting하고 string으로 초기화 합니다.
       * allowRange가 있다면 toValidateion함수를 호출 합니다.
       */
      _selectedToDateChanged: function(date) {
        this.selectedToDate = this.formatting(date);
        if(!this.value) {
          this.value = ',' + this.selectedToDate;
        } else {
          valueArr = this.value.split(',');
          valueArr[1] = this.selectedToDate;
          this.value = valueArr.join(',');
        }

        if(this.value == ",") {
          this.value = "";
        }

        if(this.allowRange && this.allowRange != '') {
          this.toValidation();
        }
      },

      /**
       * allowRange가 있을 경우 발생합니다.
       * 입력받은 fromDate가 toDate와 비교하여 허용범위 안에 있는지를 계산하고
       * 범위 밖일 경우 fromValid를 false로 리턴하여 errorMessage를 출력
       */
      fromValidation: function() {
        if(this.selectedFromDate && this.selectedToDate) {
          var fromDate = this.setHours(new Date(this.selectedFromDate));
          var toDate = this.setHours(new Date(this.selectedToDate));
          var allowFromDate = this.setHours(new Date());

          allowFromDate.setDate(toDate.getDate() - this.allowRange);

          if(fromDate < allowFromDate) {
            this.fromValid = false;
            this.clearFrom();
          } else {
            this.toValid = true;
            this.fromValid = true;
          }
        }
      },

      setHours: function(date) {
        date.setHours(0, 0, 0, 0);
        return date;
      },

      /**
       * allowRange가 있을 경우 발생합니다.
       * 입력받은 toDate가 fromDate와 비교하여 허용범위 안에 있는지를 계산하고
       * 범위 밖일 경우 toValid를 false로 리턴하여 errorMessage를 출력
       */
      toValidation: function() {
        if(this.selectedFromDate && this.selectedToDate) {
          var fromDate = this.setHours(new Date(this.selectedFromDate));
          var toDate = this.setHours(new Date(this.selectedToDate));
          var allowToDate = this.setHours(new Date());

          allowToDate.setDate(fromDate.getDate() + this.allowRange);

          if(toDate > allowToDate) {
            this.toValid = false;
            this.clearTo();
          } else {
            this.toValid = true;
            this.fromValid = true;
          }
        }
      },

      /**
       * date를 iso 표준의 string으로 변환 후 
       * locale, readFormat를 바탕으로 formatting 합니다.
       */
      formatting: function(date) {
        if(date && date != '') {
          date = (typeof(date) == 'object') ? date.toISOString() : new Date(date).toISOString();
          return moment(date).locale(this.locale).format(this.readFormat);
        }
      }      
    });
  </script>

</dom-module>
