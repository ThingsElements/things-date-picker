<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-date-picker/paper-date-picker.html">
<link rel="import" href="../paper-date-picker/paper-date-picker-dialog-style.html">
<link rel="import" href="../things-button/things-button.html">
<link rel="import" href="../things-msg-box-behavior/things-msg-box-behavior.html">
<link rel="import" href="../things-input-field/things-input-field.html">

<!--
`<things-date-from-to>` From Date와 To Date를 입력받아 기간을 표현하는 컴퍼넌트

  Example
    
    <things-date-from-to 
      locale="ko" 
      read-format="YYYY-MM-DD">
    </things-date-from-to>

@demo demo/demo-things-date-from-to.html
-->
<dom-module id="things-date-from-to">

  <template>
    <style>
      things-input-field::shadow input{
        @apply(--things-input);
        width:calc(65% - 37px);
      }
      paper-icon-button.clear{
        @apply(--things-small-icon);
        margin-right:7px;margin-left:-27px;
        opacity:.4;
        position:relative;
        top:-2px;
      }
      paper-icon-button.picker{
        @apply(--things-picker-button);
        background:url(/images/icon-resource-select.png) 55% -97px no-repeat var(--paper-blue-grey-300);
        top:1px;
      }
    </style>

    <things-input-field hidden name="[[name]]" value="[[value]]"></things-input-field>
    <div class="layout horizontal">
      <things-input-field
        label="[[fromLabel]]"
        type="text"
        name="fromDate"
        value="{{selectedFromDate}}"
        readonly>
      </things-input-field>
      <paper-icon-button class="clear" icon="clear" on-tap="clearFrom"></paper-icon-button>
      <paper-icon-button class="picker" on-tap="openFromPicker"></paper-icon-button>

      <things-input-field
        label="[[toLabel]]"
        type="text"
        name="toDate"
        value="{{selectedToDate}}"
        readonly>
      </things-input-field>
      <paper-icon-button class="clear" icon="clear" on-tap="clearTo"></paper-icon-button>
      <paper-icon-button class="picker" on-tap="openToPicker"></paper-icon-button>
    </div>

  </template>

  <script>
    Polymer({
      is: 'things-date-from-to',

      behaviors: [ 
        Things.MsgBoxBehavior
      ],

      properties: {
        /**
         * Name
         */        
        name: {
          type: String
        },

        label: {
          type: String,
          observer: '_labelChanged'
        },

        /**
         * from field label name
         */
        fromLabel: {
          type: String,
          value: 'From'
        },

        /**
         * to field label name
         */
        toLabel: {
          type: String,
          value: 'To'
        },

        /**
         * From Date
         */
        fromDate: {
          type: String
        },

        /**
         * To Date
         */
        toDate: {
          type: String
        },

        /**
         * Date picker의 기준이 되는 locale을 설정한다.
         */
        locale: {
          type: String,
          notify: true,
          value: 'en'
        },

        /**
         * date의 읽기전용 format을 설정한다.
         */
        readFormat: {
          type: String,
          notify: true,
          value: 'YYYY-MM-DD'
        },

        /**
         * date의 쓰기전용 format을 설정한다.
         */
        writeFormat: {
          type: String,
          value: 'YYYY-MM-DD'
        },

        /**
         * Form Submit시에 넘어갈 값 ex) 2015-05-01,2016-05-31
         */
        value: {
          type: String
        }        
      },

      observers: [
        '_selectedFromDateChanged(selectedFromDate)',
        '_selectedToDateChanged(selectedToDate)'
      ],      

      /**
       * label을 property로 받아서 fromLabel과 toLabel을 초기화 합니다.
       */
      _labelChanged: function(label) {
        this.fromLabel = label + ' (From)';
        this.toLabel = label + ' (to)';
      },

      /**
       * 버튼 클릭시 Date picker를 dialog 타입으로 나타나게 한다.
       */
      openFromPicker: function() {
        var dataObj = {
          owner: this,
          locale: this.locale,
          readFormat: this.readFormat,
          date: (this.selectedFromDate) ? new Date(this.selectedFromDate) : new Date()
        };  

        app.$['date-picker-dialog'].dialogToggle(dataObj, this._applyFromDate);
      },

      /**
       * 버튼 클릭시 Date picker를 dialog 타입으로 나타나게 한다.
       */      
      openToPicker: function() {
        var dataObj = {
          owner: this,
          locale: this.locale,
          readFormat: this.readFormat,
          date: (this.selectedToDate) ? new Date(this.selectedToDate) : new Date()
        };  

        app.$['date-picker-dialog'].dialogToggle(dataObj, this._applyToDate);        
      },

      /**
       * things-date-picker-dialog에 전달할 callback 함수
       * selectedFromDate를 초기화 하고 dateValidation 함수를 통해 from date와 to date 간의 validation check, false return시 selectedFromDate를 clear
       */
      _applyFromDate: function(dataObj) {
        this.selectedFromDate = dataObj.date;

        var isValid = this.dateValidation();
        if(!isValid)
          this.selectedFromDate = '';
      },

      /**
       * things-date-picker-dialog에 전달할 callback 함수
       * selectedToDate를 초기화 하고 dateValidation 함수를 통해 from date와 to date 간의 validation check, false return시 selectedToDate를 clear
       */
      _applyToDate: function(dataObj) {
        this.selectedToDate = dataObj.date;

        var isValid = this.dateValidation();
        if(!isValid)
          this.selectedToDate = '';
      },

      /**
       * from date와 to date 간의 범위 validation check, valid = true return, invalid = false return
       */
      dateValidation: function() {
        if(this.selectedFromDate && this.selectedToDate && this.selectedFromDate > this.selectedToDate)  {
          this.openInfoMsg({ title : 'Invalid Date Range!', text : 'Please Select Proper Date.', type : 'info', timer : 5000 });
          return false;
        }
        return true;
      },

      /**
       * 선택된 from date를 빈값으로 초기화
       */
      clearFrom: function() {
        this.selectedFromDate = '';
      },

      /**
       * 선택된 to date를 빈값으로 초기화
       */
      clearTo: function() {
        this.selectedToDate = '';
      },

      /**
       * From Date 선택시 - value 변경
       */
      _selectedFromDateChanged(selectedFromDate) {
        if(!this.value) {
          this.value = selectedFromDate + ',';
        } else {
          valueArr = this.value.split(',');
          valueArr[0] = selectedFromDate;
          this.value = valueArr.join(',');
        }

        if(this.value == ",") {
          this.value = "";
        }
      },

      /**
       * To Date 선택시 - value 변경
       */
      _selectedToDateChanged(selectedToDate) {
        if(!this.value) {
          this.value = ',' + selectedToDate;
        } else {
          valueArr = this.value.split(',');
          valueArr[1] = selectedToDate;
          this.value = valueArr.join(',');
        }

        if(this.value == ",") {
          this.value = "";
        }        
      }
    });
  </script>

</dom-module>
